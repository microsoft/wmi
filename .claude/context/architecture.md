# Architecture

> Last updated: 2026-01-11

## System Type

Go library providing Windows Management Instrumentation (WMI) bindings for managing Hyper-V virtualization, Windows Failover Clustering, and hardware resources on Windows Server systems.

## Core Components

### 1. WMI Core (`go/wmi/`)
Interface definitions for the WMI abstraction layer:
- `Session` - WMI session management (connect, query, enumerate)
- `Instance` - WMI object instance operations (CRUD, method invocation)
- `Class` - WMI class metadata
- `Query` - WQL query construction

### 2. WMI Instance Implementation (`pkg/wmiinstance/`)
Concrete implementation using COM/OLE automation:
- `WmiSession` - Session management via SWbemLocator
- `WmiInstance` - Wraps SWbemObject for instance operations
- `WmiClass` - Class definition access
- `WmiMethod` - Method invocation support

Uses `go-ole/go-ole` for COM interop.

### 3. Base Infrastructure (`pkg/base/`)
- `session/` - Session pooling and credential management
- `instance/` - Instance manager for lifecycle management
- `host/` - Remote host connection configuration
- `credential/` - WMI credential handling
- `query/` - Query builder utilities
- `monitor/` - WMI event monitoring

### 4. Generated WMI Classes (`server2019/`, `server23h2/`)
Auto-generated Go structs from WMI MOF schema:
- ~10,000 classes for Server 2019
- ~12,000 classes for Server 23H2
- Mirrors WMI namespace hierarchy (root/virtualization/v2, root/cimv2, etc.)
- Generated by `wmigen` tool

### 5. High-Level APIs (`pkg/`)

#### Virtualization (`pkg/virtualization/`)
Hyper-V management:
- `core/virtualsystem/` - VM lifecycle management
- `core/storage/` - Virtual disks, controllers, drives
- `core/memory/` - Memory configuration
- `core/processor/` - CPU configuration
- `core/gpu/` - GPU passthrough
- `network/` - Virtual networking

#### Cluster (`pkg/cluster/`)
Windows Failover Clustering:
- `compute/cluster/` - Cluster management
- `compute/clusternode/` - Node operations
- `compute/resourcegroup/` - Resource group management
- `compute/resource/` - Cluster resources (VMs)
- `compute/affinityrule/` - Placement rules
- `compute/groupset/` - Availability sets
- `network/` - Cluster networking
- `storage/` - Cluster shared volumes

#### Hardware (`pkg/hardware/`)
Physical host information:
- `host/` - Computer system, OS, memory info
- `network/` - Network adapters and routing

#### Operating System (`pkg/operatingsystem/`)
- `core/process/` - Process management
- `core/service/` - Windows service control

## Data Flow

```
Application Code
       │
       ▼
pkg/ High-Level APIs (virtualization, cluster, hardware)
       │
       ▼
server2019/server23h2 Generated WMI Classes
       │
       ▼
pkg/wmiinstance (COM/OLE WMI Implementation)
       │
       ▼
pkg/base/session (Session Pool)
       │
       ▼
go-ole → Windows WMI Service (winmgmt)
```

## External Dependencies

- `github.com/go-ole/go-ole` - COM/OLE automation for Windows
- `github.com/google/uuid` - UUID generation
- `github.com/pkg/errors` - Error wrapping
- `github.com/nwoodmsft/iso9660` - ISO file handling
- `golang.org/x/sys` - Windows system calls

## Key Design Decisions

1. **Generated Code Approach**: WMI classes are auto-generated from MOF schemas to ensure type safety and complete API coverage

2. **Session Pooling**: Sessions are cached by namespace+server+domain to avoid expensive reconnection

3. **Local Host Optimization**: Local connections skip authentication overhead by using empty server name

4. **Collection Pattern**: Most entities have `*Collection` types with batch operations

5. **Embedded XML**: Supports WMI embedded instance serialization for complex configurations

6. **Build Constraint**: All code uses `//go:build windows` - library only works on Windows
